name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: [self-hosted, linux]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Ensure Kind cluster exists
        run: |
          if ! kind get clusters 2>/dev/null | grep -q "order-cluster"; then
            echo "Creating Kind cluster..."
            kind create cluster --name order-cluster
          else
            echo "âœ… Cluster already exists"
          fi
      
      - name: ğŸš€ Deploy to Kubernetes
        run: |
          echo "Deploying to Kubernetes..."
          kubectl apply -f k8s/complete-deployment.yaml
          
      - name: â³ Wait for Rollout
        run: |
          echo "Waiting for pods to be ready..."
          kubectl rollout status deployment/order-management-system -n order-management --timeout=180s
      
      - name: ğŸ“‹ Show Deployment Status
        run: |
          echo ""
          echo "========== PODS =========="
          kubectl get pods -n order-management
          echo ""
          echo "========== SERVICES =========="
          kubectl get svc -n order-management
          echo ""
          echo "âœ… Deployment Complete!"
```

---

## ğŸ“Š How It Will Look on GitHub

**Before (One Pipeline):**
```
CI Pipeline
â”œâ”€â”€ lint
â”œâ”€â”€ sast
â”œâ”€â”€ sca
â”œâ”€â”€ test
â”œâ”€â”€ build
â”œâ”€â”€ docker-build
â”œâ”€â”€ image-scan
â”œâ”€â”€ container-test
â”œâ”€â”€ push
â””â”€â”€ deploy        â† Mixed with CI
```

**After (Two Pipelines):**
```
CI Pipeline                    CD Pipeline
â”œâ”€â”€ ğŸ” lint                    â””â”€â”€ ğŸš€ Deploy to Kubernetes
â”œâ”€â”€ ğŸ›¡ï¸ sast                        (Triggered after CI succeeds)
â”œâ”€â”€ ğŸ“¦ sca
â”œâ”€â”€ ğŸ§ª test
â”œâ”€â”€ ğŸ”¨ build
â”œâ”€â”€ ğŸ³ docker-build
â”œâ”€â”€ ğŸ” image-scan
â”œâ”€â”€ âœ… container-test
â””â”€â”€ ğŸš€ push
```

---

## ğŸ¯ How It Works
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   git push                                                      â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   CI Pipeline (ci.yml) - GitHub Cloud                   â”‚  â”‚
â”‚   â”‚   âœ… Lint â†’ SAST â†’ SCA â†’ Test â†’ Build â†’ Docker â†’ Push   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                   â”‚
â”‚                             â”‚ triggers (on success)             â”‚
â”‚                             â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   CD Pipeline (cd.yml) - Self-Hosted Runner             â”‚  â”‚
â”‚   â”‚   ğŸš€ Deploy to Kubernetes                                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜